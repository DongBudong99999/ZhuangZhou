<html>
<head>
    <title>Dongbudong's graduation project----file upload</title>
    <!-- html 5 的编码设置方式 -->
    <meta charset="UTF-8">
    <!-- start: Mobile Specific -->
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <!-- end: Mobile Specific -->

    <!-- start: CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet"/>
    <link href="css/bootstrap-responsive.min.css" rel="stylesheet"/>
    <link href="css/style.min.css" rel="stylesheet"/>
    <link href="css/style-responsive.min.css" rel="stylesheet"/>
    <link href="css/retina.css" rel="stylesheet"/>
    <!-- end: CSS -->

    <!--<script src="http://www.jq22.com/jquery/jquery-1.10.2.js"></script>-->
    <script type="text/javascript" src="js/xlsx.core.min.js"></script>

    <!-- The HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <link id="ie-style" href="css/ie.css" rel="stylesheet">
    <![endif]-->

    <!--[if IE 9]>
    <link id="ie9style" href="css/ie9.css" rel="stylesheet">
    <![endif]-->

    <!-- start: Favicon and Touch Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="ico/apple-touch-icon-144-precomposed.png"/>
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="ico/apple-touch-icon-114-precomposed.png"/>
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="ico/apple-touch-icon-72-precomposed.png"/>
    <link rel="apple-touch-icon-precomposed" href="ico/apple-touch-icon-57-precomposed.png"/>
    <link rel="shortcut icon" href="ico/favicon.png"/>
    <!-- end: Favicon and Touch Icons -->

    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

    <script type="text/javascript" src="static/js/jquery-3.2.1.js"></script>
    <script type="text/javascript" src="http://malsup.github.io/jquery.form.js"></script>
    <!--
    <link rel="stylesheet" type="text/css" href="styles.css">
    -->


    <!--<%&#45;&#45;上传组建美化css代码&#45;&#45;%>-->
    <style type="text/css">
        .a-upload {
            padding: 4px 10px;
            height: 20px;
            line-height: 20px;
            position: relative;
            cursor: pointer;
            color: #888;
            background: #fafafa;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
            display: inline-block;
            *display: inline;
            *zoom: 1
        }

        .a-upload input {
            position: absolute;
            font-size: 100px;
            right: 0;
            top: 0;
            opacity: 0;
            filter: alpha(opacity=0);
            cursor: pointer
        }

        .a-upload:hover {
            color: #444;
            background: #eee;
            border-color: #ccc;
            text-decoration: none
        }

        .file {
            position: relative;
            display: inline-block;
            background: #D0EEFF;
            border: 1px solid #99D3F5;
            border-radius: 4px;
            padding: 4px 12px;
            overflow: hidden;
            color: #1E88C7;
            text-decoration: none;
            text-indent: 0;
            line-height: 20px;
        }

        .file input {
            position: absolute;
            font-size: 100px;
            right: 0;
            top: 0;
            opacity: 0;
        }

        .file:hover {
            background: #AADFFD;
            border-color: #78C3F3;
            color: #004974;
            text-decoration: none;
        }
    </style>
    <style type="text/css">
        .upload_form {
            width: 1200px;
            height: 100px;
            /*margin-left: -150px;*/
            /*margin-top: -100px;*/
            top: 10%;
            left: 15%;
            position: absolute;
            float: top;
        }

        .file_table {
            width: 800%;
            height: 20%;
            /*margin-left: -150px;*/
            /*margin-top: -100px;*/
            top: 20%;
            left: 25%;
            position: absolute;
            border: 0;
        }
    </style>

    <script type="text/javascript">
        (function () {
            if (!window.localStorage) {
                console.log('浏览器不支持localStorage');
            }
            var size = 0;
            for (item in window.localStorage) {
                if (window.localStorage.hasOwnProperty(item)) {
                    size += window.localStorage.getItem(item).length;
                }
            }
            console.log('当前localStorage使用容量为' + (size / 1024).toFixed(2) + 'KB');
        })()


        function getCookie(name) {
            var strcookie = document.cookie;//获取cookie字符串
            var arrcookie = strcookie.split("; ");//分割
            //遍历匹配
            for (var i = 0; i < arrcookie.length; i++) {
                var arr = arrcookie[i].split("=");
                if (arr[0] == name) {
                    return arr[1];
                }
            }
            return "";

        }

        function setCookie(c_name, value) {
            document.cookie = c_name + "=" + value
        }

        //生成该excel文件对应的html文件 ，加载速度超级慢
        function readExceltoHtml(f) {
            alert(f)
            var file_name = f;
            var file_path = '"/Users/dongbudong/IdeaProjects/SpringBoot_demo1/src/main/resources/static/xlsx/' + file_name + '"';

            //
            // // var formFile = new FormData();
            // // formFile.append("file", file);
            // // var data = formFile;
            //
            alert("进入方法！")
            // var data1 = {"file_path": "/Users/dongbudong/IdeaProjects/SpringBoot_demo1/src/main/resources/static/xlsx/T5.xlsx" };
            var data1 = '{"file_path":' + file_path + '}';
            console.log(data1);
            $.ajax({
                url: "upload/getPath",
                type: "POST",
                data: data1,
                // processData: false,//用于对data参数进行序列化处理 这里必须false
                // contentType: false, //必须
                headers: {'Content-Type': 'application/json;charset=utf-8'},
                success: function (res) {
                    if (res) {
                        alert("上传成功！");

                        var excel_html = res;
                    }
                    console.log(res);
                    show_excel();

                },
                error: function (err) {
                    alert("网络连接失败,稍后重试", err);
                }

            });
        }
    </script>
    <script>
        function show_excel() {
            window.location.href = "excel.html";
            // document.getElementById("show").innerHTML = '<object type="text/html" data="excel.html" width="120%" height="800px"></object>';
            alert("文件读取&绘制页面中······  大约30s完成");
        }
    </script>

    <script>
        var btn1 = document.getElementById("btn1");
        /*实名函数*/
        var count = 0;
        var handle1 = function () {
            alert(count++);
            if (count == 3) {
                alert("事件结束")
                btn1.removeEventListener("click", handle1, false);
            }
        }
    </script>

</head>

<body>

<!--<h> 以下是顶端导航栏</h>-->
<iframe src="header.html" width="100%" height="41px" frameborder=0></iframe>
<!--<h> 以上是顶端导航栏</h>-->

<!--<h>以下是侧面导航栏</h>-->
<div class="container-fluid-full">
    <div class="row-fluid">

        <!-- start: Main Menu -->
        <div id="sidebar-left" class="span2">

            <div class="row-fluid actions">

                <input type="text" class="search span12" placeholder="..."/>

            </div>

            <div class="nav-collapse sidebar-nav">
                <ul class="nav nav-tabs nav-stacked main-menu">
                    <li><a href="index.html"><i class="icon-bar-chart"></i><span class="hidden-tablet"> 看板</span></a>
                    </li>
                    <li><a href="upload.html"><i class="icon-eye-open"></i><span
                            class="hidden-tablet"> 文件管理</span></a></li>
                    <li><a href="widgets.html"><i class="icon-dashboard"></i><span
                            class="hidden-tablet"> 窗口小部件</span></a>
                    </li>
                    <li>
                        <a class="dropmenu" href="#"><i class="icon-folder-close-alt"></i><span
                                class="hidden-tablet">样图</span>
                            <span class="label">3</span></a>
                        <ul>
                            <li><a class="submenu" href="infrastructure.html"><i class="icon-hdd"></i><span
                                    class="hidden-tablet"> 基础设置</span></a></li>
                            <li><a class="submenu" href="messages.html"><i class="icon-envelope"></i><span
                                    class="hidden-tablet"> 系统消息</span></a></li>
                            <li><a class="submenu" href="tasks.html"><i class="icon-tasks"></i><span
                                    class="hidden-tablet"> 任务</span></a></li>
                        </ul>
                    </li>
                    <li><a href="form.html"><i class="icon-edit"></i><span class="hidden-tablet"> 表格</span></a></li>
                    <li><a href="chart.html"><i class="icon-list-alt"></i><span class="hidden-tablet"> 图表</span></a>
                    </li>
                    <li><a href="typography.html"><i class="icon-font"></i><span
                            class="hidden-tablet"> 排版样式</span></a></li>
                    <li><a href="gallery.html"><i class="icon-picture"></i><span
                            class="hidden-tablet"> 图库</span></a></li>
                    <li><a href="table.html"><i class="icon-align-justify"></i><span
                            class="hidden-tablet"> 数据库</span></a></li>
                    <li><a href="echarts.html"><i class="icon-calendar"></i><span
                            class="hidden-tablet"> 数据可视化</span></a></li>
                    <li><a href="file-manager.html"><i class="icon-folder-open"></i><span
                            class="hidden-tablet"> 文件管理</span></a>
                    </li>
                    <li><a href="to_db.html"><i class="icon-folder-open"></i><span
                            class="hidden-tablet"> 录入数据库</span></a>
                    </li>
                    <li><a href="selector.html"><i class="icon-folder-open"></i><span
                            class="hidden-tablet"> 计算公式</span></a>
                    </li>
                    <li><a href="icon.html"><i class="icon-star"></i><span class="hidden-tablet"> 用户注册</span></a>
                    </li>
                    <li><a href="login.html"><i class="icon-lock"></i><span class="hidden-tablet"> 登录页面</span></a>
                    </li>
                </ul>
            </div>
        </div>
    </div>

</div>
<!--<h>一上是侧面导航栏</h>-->


<form class="upload_form" enctype="multipart/form-data">
    <a href="javascript:;" class="file">
        选择文件
        <input type="file" id="fileUp" name="">
    </a>


    <!--<button  onclick="upload123()">点我上传</button>-->
    <a href="javascript:;" class="a-upload">点我上传
        <input type="button" name="" id="" onclick="upload123()"></a>

</form>
<script type="text/javascript">
    var files;
    $('#fileUp').change(function (e) {
        alert("!!!!!!!!!")
        files = e.target.files;

        var fileReader = new FileReader();
        fileReader.onload = function (ev) {
            // console.log("~~~~~" + ev)
            try {
                var data = ev.target.result
                console.log(data)
                workbook = XLSX.read(data, {
                    type: 'binary'
                }), // 以二进制流方式读取得到整份excel表格对象
                    persons = []; // 存储获取到的数据
            } catch (e) {
                console.log('文件类型不正确');
                return;
            }

            // 表格的表格范围，可用于判断表头是否数量是否正确
            var fromTo = '';
            // 遍历每张表读取
            for (var sheet in workbook.Sheets) {
                if (workbook.Sheets.hasOwnProperty(sheet)) {
                    fromTo = workbook.Sheets[sheet]['!ref'];
                    console.log(fromTo);
                    persons = persons.concat(XLSX.utils.sheet_to_json(workbook.Sheets[sheet]));
                    // break; // 如果只取第一张表，就取消注释这行
                }
            }
            console.log("========" + JSON.stringify(persons))
            localStorage.setItem(files[0].name, JSON.stringify(persons))


        };
        // 以二进制方式打开文件
        fileReader.readAsBinaryString(files[0]);
    });

</script>
<script type="text/javascript">
    var fileM = document.querySelector("#fileUp");//
    function upload123() {

//获取文件对象，files是文件选取控件的属性，存储的是文件选取控件选取的文件对象，类型是一个数组
        var fileObj = fileM.files[0];
        var fileReader = new FileReader();

        // localStorage.setItem(fileObj.name, fileObj);
        // alert(fileObj.name)
//创建formdata对象，formData用来存储表单的数据，表单数据时以键值对形式存储的。
        var formData = new FormData();
        formData.append('file', fileObj);
        $.ajax({
            url: "/testUploadFiles",
            type: "post",
            dataType: "json",
            data: formData,
            async: false,
            cache: false,
            contentType: false,
            processData: false,
            success: function (res) {
                // fileArray.push(res.uploadFileName)
                alert(res.uploadFileName + "  上传成功");
            },
        });


    }
</script>
<div >
    <!--<div>以下是文件列表</div>-->
    <a id="file_list"></a>
</div>
<script type="text/javascript">
    var filename;
    var htmlstr;
    // alert("空餐传递")
    $.ajax({
        url: "/showFileList",
        type: "POST",

        // processData: false,//用于对data参数进行序列化处理 这里必须false
        // contentType: false, //必须
        headers: {'Content-Type': 'application/json;charset=utf-8'},
        success: function (fileList) {
            if (fileList) {
                // alert("已接到返回，长度为" + fileList.length)
                // // for(i=0;i<fileList.length;i++){
                // //     console.log(fileList[i]);
                // // }
                //
                var cols = 2; //2列
                var rows = fileList.length; //4行
                htmlstr = "<table class='file_table' style='height: 800px;' border='1px'>";
                for (var m = 0; m < rows; m++) {
                    filename = fileList[m].split('"');
                    console.log(filename);
                    htmlstr += "<tr>";
                    for (var n = 0; n < cols; n++) {
                        if (n == 0) {
                            htmlstr += "<td  width='40%'>" + filename + "</td>";
                        }
                        if (n = 1) {
                            htmlstr += "<td > <a href='http://localhost:8080/xlsx/" + filename + "'>下载</a>&nbsp;&nbsp;&nbsp;&nbsp;" +
                                "<a onclick='showexcel(" + '"' + filename + '"' + ")'>预览</a> </td>";
                        }
                    }
                    htmlstr += "</tr>";
                }
                htmlstr += "</table>";
                console.log(htmlstr)
                document.getElementById("file_list").innerHTML = htmlstr;
                // document.write(htmlstr)
            }
            console.log(fileList);


        },
        error: function (err) {
            alert("网络连接失败,稍后重试", err);
        }

    });
</script>
<script type="text/javascript">
    function showexcel(excel) {
        var persons = JSON.parse(localStorage.getItem(excel));

        // console.log(persons.toString())
        $(".tablehead").html("");
        $(".tablebody").html("");
        for (var j = 0; j < persons.length; j++) {
            var arr = persons[j];
            if (j == 0) {
                $(".tablehead").append("<tr class='exceltitle'></tr>");
            }
            $(".tablebody").append("<tr class='excelcontent'></tr>");
            for (var i in arr) {
                //alert(i+"---"+arr[i]);
                if (j == 0) {
                    $(".exceltitle").append("<th>" + i + "</th>");
                }
                $(".excelcontent").eq(j).append("<td>" + arr[i] + "</td>");
            }
        }

    }
</script>
<!--<span style="color:red;font-size:16px">[不能超过4M]</span>-->
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;


<!--<table class="file_table">-->
<!--<tr>-->
<!--<td id="index1"></td>-->
<!--<td>预览</td>-->
<!--</tr>-->
<!--</table>-->


</div>
<div id="show"></div>


<script type="text/javascript">


</script>
<table class="exceltable">
    <thead class="tablehead"></thead>
    <tbody class="tablebody"></tbody>
</table>

</body>
</html>
